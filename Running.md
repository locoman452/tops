# Instructions for Running TOPS #

TOPS consists of a number of processes that provide core and project-specific services. Processes can be distributed across multiple hosts but, for the best performance and easiest management, should all be run on a single multi-core host. The only exceptions are any services that need direct access to resources on a remote host, such as a particular serial port.

The top-level start program launches all the services specified in the [run-time configuration](RuntimeConfig.md) files on a single host. The start program is a simple shell wrapper around the start.py python program. The start program can be run from any working directory, so the following are all equivalent (assuming that the given path to the start program is valid in each case):
```
% ./start
% ./tops/start
% /usr/local/lib/tops/start
```
You should generally not set the PYTHONPATH environment variable before running the start program. In case you do, its value will override the default setting.

For help on the available command-line options, use:
```
% start --help
Usage: start [options]

Options:
  -h, --help         show this help message and exit
  --verbose          generate verbose output
  --project=PROJECT  python module path of project to start, e.g., tops.sdss3
  --config=CONFIG    path of an INI file containing run-time configuration
                     parameters that will override the defaults
  --readkey          read private data key from stdin
```
Most [run-time configuration](RuntimeConfig.md) is read from text files, so you will normally only need to specify the project you wish to start, e.g.
```
% start --project tops.sdss3
```
The project is specified as a fully-qualified python module path. The corresponding filesystem path will be searched for any project-specific run-time initialization. As long as your project is under the top-level tops module, you do not need to set PYTHONPATH before running the start program.

In case you need to override any of the default [run-time parameters](RuntimeConfig.md), use the --config option to specify an INI file that is added to the end of the configuration parameter search path.

The readkey option is used to propagate private data between processes and should not normally be used.

Running the SDSS-3 code generally requires that you are on the 2.5m subnet at APO, where communication with the TCC is possible. For testing on another machine, you can start just the core services which will allow you to use the web-based logging and archiving clients:
```
% start
start: Setting PYTHONPATH = /Users/david/Cosmo/SDSS/Design/dev
start: service tops.core.network.logging.server is pid 31651
start: service tops.core.network.archiving.server is pid 31654
start: Services can be killed with: kill -INT `cat /tmp/tops/pidlist`
```
Note that there is no corresponding _stop_ script. Instead, the _start_ script displays a simple command line that will kill each of the processes in the correct order.

If you include the SDSS-3 processes, you will instead see something like this:
```
% start --project tops.sdss3
start: Setting PYTHONPATH = /Users/david/Cosmo/SDSS/Design/dev
Enter the pass phrase: 
start: service tops.core.network.logging.server is pid 31751
start: service tops.core.network.archiving.server is pid 31753
start: service tops.sdss3.tcc.listener is pid 31755
start: service tops.sdss3.tcc.session is pid 31757
start: Services can be killed with: kill -INT `cat /tmp/tops/pidlist`
```
Note that, in this case, you must enter a pass phrase that will be used to decrypt any private data in the [configuration files](RuntimeConfig.md) such as the TCC login password.

There is a delay of several seconds between the start of each process. This is to allow the start program a chance to detect if a process dies during its initialization phase. The amount of delay is a [configuration parameter](RuntimeConfig.md).

Once the software is running, log messages generated by any process are generally directed to the [logging service](Logging.md). The only exception are log messages that are generated before network communications have been established, perhaps because of a networking-related error. These messages are collected in files that, by default, are under /tmp/tops/log/ but this location might be changed in the [configuration files](RuntimeConfig.md).